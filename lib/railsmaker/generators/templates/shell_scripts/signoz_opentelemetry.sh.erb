#!/bin/bash
set -e

if ! command -v docker &> /dev/null; then
    echo "Error: Docker is not installed. Please install Docker first."
    echo "Visit https://docs.docker.com/get-docker/ for installation instructions."
    exit 1
fi

if ! command -v docker compose &> /dev/null; then
    echo "Error: Docker Compose is not installed. Please install Docker Compose first."
    echo "Visit https://docs.docker.com/compose/install/ for installation instructions."
    exit 1
fi

if ! command -v git &> /dev/null; then
    echo "Error: Git is not installed. Please install Git first."
    echo "Visit https://git-scm.com/downloads for installation instructions."
    exit 1
fi

git clone -b main https://github.com/SigNoz/signoz.git --depth 1 signoz-opentelemetry --branch <%= signoz_version %>

cd signoz-opentelemetry/deploy/

echo "üìù Configuring SigNoz OpenTelemetry..."
sed -i "s|SIGNOZ_COLLECTOR_ENDPOINT=http://host.docker.internal:4317|SIGNOZ_COLLECTOR_ENDPOINT=http://<%= options[:signoz_server_host] %>:4317|" docker/generator/infra/docker-compose.yaml
sed -i "s|host.name=signoz-host|host.name=<%= options[:hostname] || 'signoz-host' %>|" docker/generator/infra/docker-compose.yaml
sed -i '/external: true/d' docker/generator/infra/docker-compose.yaml

# Add docker group permissions to the otel-agent service
DOCKER_GID=$(getent group docker | cut -d: -f3)
sed -i "/image: otel\/opentelemetry-collector-contrib/a\    group_add:\n      - ${DOCKER_GID}" docker/generator/infra/docker-compose.yaml

# Uncomment the ports section
sed -i 's/# ports:/ports:/' docker/generator/infra/docker-compose.yaml
sed -i 's/#   - /  - /' docker/generator/infra/docker-compose.yaml
sed -i 's/#   - /  - /' docker/generator/infra/docker-compose.yaml

echo "üöÄ Starting SigNoz OpenTelemetry services..."
docker compose -f docker/generator/infra/docker-compose.yaml up -d --remove-orphans 2>&1 | grep -E 'Status:|Created|Started|Error|Warning' || true

echo "‚ú® Verifying services..."
if docker compose -f docker/generator/infra/docker-compose.yaml ps --status running | grep -q "otel-agent"; then
    echo "‚úÖ SigNoz OpenTelemetry collector is running successfully!"
else
    echo "‚ùå Error: SigNoz OpenTelemetry collector failed to start. Please check the logs with 'docker compose logs'"
    exit 1
fi
